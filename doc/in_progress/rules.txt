if melody-event
return melody-event

|if not player-updated
|if needs-new-segment
|---
|call get-new-segment
|assert-player-updated


|if not player-updated
|if not needs-new-segment
|if not (player-action = SIMILAR-ENSEMBLE)
|---
|assert player-updated

|if not player-updated
|if not needs-new-segment
|if player-action = SIMILAR-ENSEMBLE
|---
|call update-from-ensemble
|assert-player-updated

if segment-established  \
if start-new-segment    same as needs-new segment and player-updated
if not (= player-action SIMILAR-PLAYER)
if sync-beat-player-id
---
assert sync-beat-player-id = player's sync-beat-player-id

if segment-established
if start-new-segment
if player-action = SIMILAR-ENSEMBLE
---
assert sync-beat-player-id = player with mm

if segment-established
if sync-beat-player-id
---
assert melody-event = sync-beat event (melody/sync-beat-follow)

if segment-established
if not sync-beat-player-id
---
assert play-note-prob = (rand-int 10)

if play-note-prob
if (> player-density play-note-prob)
---
assert choose-note
